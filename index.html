<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Phân Bổ Các Loại Giờ</title>
    <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        input { width: 60px; }
        .sub-table { margin-left: 20px; border: none; }
        .sub-table td { border: none; }
        .total { font-weight: bold; background-color: #e6f3ff; }
        #error_msg { color: red; display: none; }
    </style>
</head>
<body>
    <h2>Phân Bổ Các Loại Giờ</h2>
    
    <!-- Phần thông tin học phần -->
    <div id="info-hoc-phan">
        <h3>Thông tin học phần</h3>
        <p>Số tín chỉ: <input type="number" id="total_credits" value="0" min="0" onchange="updateInfo()"></p>
        <p>Lý thuyết (TC): <input type="number" id="theory_credits" value="0" min="0" onchange="updateInfo()"></p>
        <p>Thực hành/Thí nghiệm/Thảo luận (TC): <input type="number" id="practice_credits" value="0" min="0" onchange="updateInfo()"></p>
        <p>Tự học (tiết): <span id="self_study_hours">0</span></p>
        <p>Gợi ý: Cần thêm <span id="suggested_hours">0</span> giờ để đạt tổng <span id="target_total">0</span> giờ học tập.</p>
        <p id="error_msg">Lỗi: Tổng tín chỉ không khớp!</p>
    </div>
    
    <table id="main-table">
        <thead>
            <tr>
                <th>Phân bổ các loại giờ</th>
                <th>Lý thuyết (giờ)</th>
                <th>Thực hành (giờ)</th>
                <th>Tự học/Tự nghiên cứu (giờ)</th>
                <th>Tổng (giờ)</th>
            </tr>
        </thead>
        <tbody>
            <!-- Phần Số giờ giảng dạy -->
            <tr class="total">
                <td><strong>Số giờ giảng dạy (lý thuyết/thực hành)</strong></td>
                <td id="total_giang_day_ly_thuyet">0</td>
                <td id="total_giang_day_thuc_hanh">0</td>
                <td id="total_giang_day_tu_hoc">0</td>
                <td id="total_giang_day">0</td>
            </tr>
            <tr>
                <td colspan="5">
                    <table class="sub-table">
                        <tr>
                            <td>Trực diện (tại phòng học)</td>
                            <td><input type="number" id="truc_dien_ly_thuyet" value="0" min="0" onchange="updateTotals()"></td>
                            <td><input type="number" id="truc_dien_thuc_hanh" value="0" min="0" onchange="updateTotals()"></td>
                            <td><input type="number" id="truc_dien_tu_hoc" value="0" min="0" onchange="updateTotals()"></td>
                            <td id="total_truc_dien">0</td>
                        </tr>
                        <tr>
                            <td>Trực tuyến đồng bộ</td>
                            <td><input type="number" id="truc_tuyen_dong_bo_ly_thuyet" value="0" min="0" onchange="updateTotals()"></td>
                            <td><input type="number" id="truc_tuyen_dong_bo_thuc_hanh" value="0" min="0" onchange="updateTotals()"></td>
                            <td><input type="number" id="truc_tuyen_dong_bo_tu_hoc" value="0" min="0" onchange="updateTotals()"></td>
                            <td id="total_truc_tuyen_dong_bo">0</td>
                        </tr>
                        <tr>
                            <td>Trực tuyến không đồng bộ</td>
                            <td><input type="number" id="truc_tuyen_khong_dong_bo_ly_thuyet" value="0" min="0" onchange="updateTotals()"></td>
                            <td><input type="number" id="truc_tuyen_khong_dong_bo_thuc_hanh" value="0" min="0" onchange="updateTotals()"></td>
                            <td><input type="number" id="truc_tuyen_khong_dong_bo_tu_hoc" value="0" min="0" onchange="updateTotals()"></td>
                            <td id="total_truc_tuyen_khong_dong_bo">0</td>
                        </tr>
                        <tr>
                            <td>Đi thực tế, trải nghiệm</td>
                            <td><input type="number" id="di_thuc_te_ly_thuyet" value="0" min="0" onchange="updateTotals()"></td>
                            <td><input type="number" id="di_thuc_te_thuc_hanh" value="0" min="0" onchange="updateTotals()"></td>
                            <td><input type="number" id="di_thuc_te_tu_hoc" value="0" min="0" onchange="updateTotals()"></td>
                            <td id="total_di_thuc_te">0</td>
                        </tr>
                    </table>
                </td>
            </tr>

            <!-- Phần Số giờ tự học và khác -->
            <tr class="total">
                <td><strong>Số giờ tự học và khác</strong></td>
                <td id="total_tu_hoc_ly_thuyet">0</td>
                <td id="total_tu_hoc_thuc_hanh">0</td>
                <td id="total_tu_hoc_tu_hoc">0</td>
                <td id="total_tu_hoc">0</td>
            </tr>
            <tr>
                <td colspan="5">
                    <table class="sub-table">
                        <tr>
                            <td>Tự học, tự nghiên cứu</td>
                            <td><input type="number" id="tu_hoc_nghien_cuu_ly_thuyet" value="0" min="0" onchange="updateTotals()"></td>
                            <td><input type="number" id="tu_hoc_nghien_cuu_thuc_hanh" value="0" min="0" onchange="updateTotals()"></td>
                            <td><input type="number" id="tu_hoc_nghien_cuu_tu_hoc" value="0" min="0" onchange="updateTotals()"></td>
                            <td id="total_tu_hoc_nghien_cuu">0</td>
                        </tr>
                        <tr>
                            <td>Làm việc nhóm</td>
                            <td><input type="number" id="lam_viec_nhom_ly_thuyet" value="0" min="0" onchange="updateTotals()"></td>
                            <td><input type="number" id="lam_viec_nhom_thuc_hanh" value="0" min="0" onchange="updateTotals()"></td>
                            <td><input type="number" id="lam_viec_nhom_tu_hoc" value="0" min="0" onchange="updateTotals()"></td>
                            <td id="total_lam_viec_nhom">0</td>
                        </tr>
                        <tr>
                            <td>Đi thực tế, trải nghiệm</td>
                            <td><input type="number" id="di_thuc_te_tu_hoc_ly_thuyet" value="0" min="0" onchange="updateTotals()"></td>
                            <td><input type="number" id="di_thuc_te_tu_hoc_thuc_hanh" value="0" min="0" onchange="updateTotals()"></td>
                            <td><input type="number" id="di_thuc_te_tu_hoc_tu_hoc" value="0" min="0" onchange="updateTotals()"></td>
                            <td id="total_di_thuc_te_tu_hoc">0</td>
                        </tr>
                        <tr>
                            <td>Thực hành</td>
                            <td><input type="number" id="thuc_hanh_ly_thuyet" value="0" min="0" onchange="updateTotals()"></td>
                            <td><input type="number" id="thuc_hanh_thuc_hanh" value="0" min="0" onchange="updateTotals()"></td>
                            <td><input type="number" id="thuc_hanh_tu_hoc" value="0" min="0" onchange="updateTotals()"></td>
                            <td id="total_thuc_hanh">0</td>
                        </tr>
                        <tr>
                            <td>Ôn thi, kiểm tra, đánh giá</td>
                            <td><input type="number" id="on_thi_kiem_tra_ly_thuyet" value="0" min="0" onchange="updateTotals()"></td>
                            <td><input type="number" id="on_thi_kiem_tra_thuc_hanh" value="0" min="0" onchange="updateTotals()"></td>
                            <td><input type="number" id="on_thi_kiem_tra_tu_hoc" value="0" min="0" onchange="updateTotals()"></td>
                            <td id="total_on_thi_kiem_tra">0</td>
                        </tr>
                        <tr>
                            <td>Hoạt động khác (ghi rõ): <input type="text" id="hoat_dong_khac_mo_ta" placeholder="Mô tả" style="width: 200px;"></td>
                            <td><input type="number" id="hoat_dong_khac_ly_thuyet" value="0" min="0" onchange="updateTotals()"></td>
                            <td><input type="number" id="hoat_dong_khac_thuc_hanh" value="0" min="0" onchange="updateTotals()"></td>
                            <td><input type="number" id="hoat_dong_khac_tu_hoc" value="0" min="0" onchange="updateTotals()"></td>
                            <td id="total_hoat_dong_khac">0</td>
                        </tr>
                    </table>
                </td>
            </tr>

            <!-- Tổng chung -->
            <tr class="total">
                <td><strong>Tổng</strong></td>
                <td id="grand_total_ly_thuyet">0</td>
                <td id="grand_total_thuc_hanh">0</td>
                <td id="grand_total_tu_hoc">0</td>
                <td id="grand_total">0</td>
            </tr>
        </tbody>
    </table>

    <button onclick="exportToWord()">Tải file Word</button>

    <script>
        function updateSubTotal(idPrefix) {
            const lyThuyet = parseInt(document.getElementById(idPrefix + '_ly_thuyet').value) || 0;
            const thucHanh = parseInt(document.getElementById(idPrefix + '_thuc_hanh').value) || 0;
            const tuHoc = parseInt(document.getElementById(idPrefix + '_tu_hoc').value) || 0;
            const total = lyThuyet + thucHanh + tuHoc;
            document.getElementById('total_' + idPrefix).textContent = total;
            return { lyThuyet, thucHanh, tuHoc, total };
        }

        function updateGiangDayTotals() {
            const rows = ['truc_dien', 'truc_tuyen_dong_bo', 'truc_tuyen_khong_dong_bo', 'di_thuc_te'];
            let sumLy = 0, sumThuc = 0, sumTu = 0, sumTotal = 0;
            rows.forEach(row => {
                const data = updateSubTotal(row);
                sumLy += data.lyThuyet;
                sumThuc += data.thucHanh;
                sumTu += data.tuHoc;
                sumTotal += data.total;
            });
            document.getElementById('total_giang_day_ly_thuyet').textContent = sumLy;
            document.getElementById('total_giang_day_thuc_hanh').textContent = sumThuc;
            document.getElementById('total_giang_day_tu_hoc').textContent = sumTu;
            document.getElementById('total_giang_day').textContent = sumTotal;
        }

        function updateTuHocTotals() {
            const rows = ['tu_hoc_nghien_cuu', 'lam_viec_nhom', 'di_thuc_te_tu_hoc', 'thuc_hanh', 'on_thi_kiem_tra', 'hoat_dong_khac'];
            let sumLy = 0, sumThuc = 0, sumTu = 0, sumTotal = 0;
            rows.forEach(row => {
                const data = updateSubTotal(row);
                sumLy += data.lyThuyet;
                sumThuc += data.thucHanh;
                sumTu += data.tuHoc;
                sumTotal += data.total;
            });
            document.getElementById('total_tu_hoc_ly_thuyet').textContent = sumLy;
            document.getElementById('total_tu_hoc_thuc_hanh').textContent = sumThuc;
            document.getElementById('total_tu_hoc_tu_hoc').textContent = sumTu;
            document.getElementById('total_tu_hoc').textContent = sumTotal;
        }

        function updateGrandTotal() {
            const giangDayLy = parseInt(document.getElementById('total_giang_day_ly_thuyet').textContent) || 0;
            const giangDayThuc = parseInt(document.getElementById('total_giang_day_thuc_hanh').textContent) || 0;
            const giangDayTu = parseInt(document.getElementById('total_giang_day_tu_hoc').textContent) || 0;
            const tuHocLy = parseInt(document.getElementById('total_tu_hoc_ly_thuyet').textContent) || 0;
            const tuHocThuc = parseInt(document.getElementById('total_tu_hoc_thuc_hanh').textContent) || 0;
            const tuHocTu = parseInt(document.getElementById('total_tu_hoc_tu_hoc').textContent) || 0;

            document.getElementById('grand_total_ly_thuyet').textContent = giangDayLy + tuHocLy;
            document.getElementById('grand_total_thuc_hanh').textContent = giangDayThuc + tuHocThuc;
            document.getElementById('grand_total_tu_hoc').textContent = giangDayTu + tuHocTu;
            document.getElementById('grand_total').textContent = (giangDayLy + giangDayThuc + giangDayTu) + (tuHocLy + tuHocThuc + tuHocTu);
        }

        function updateTotals() {
            updateGiangDayTotals();
            updateTuHocTotals();
            updateGrandTotal();
            updateInfo(); // Cập nhật thông tin học phần sau khi tổng thay đổi
        }

        function updateInfo() {
            // Cập nhật tự học (tiết) từ tổng tự học
            const totalTuHoc = parseInt(document.getElementById('grand_total_tu_hoc').textContent) || 0;
            document.getElementById('self_study_hours').textContent = totalTuHoc;

            // Tính gợi ý giờ (giả sử 45 giờ/tín chỉ)
            const totalCredits = parseInt(document.getElementById('total_credits').value) || 0;
            const targetTotal = totalCredits * 45; // Hệ số 45, chỉnh sửa nếu cần
            const currentTotal = parseInt(document.getElementById('grand_total').textContent) || 0;
            const suggested = Math.max(0, targetTotal - currentTotal);
            document.getElementById('suggested_hours').textContent = suggested;
            document.getElementById('target_total').textContent = targetTotal;

            // Kiểm tra lỗi tổng tín chỉ
            const theoryCredits = parseInt(document.getElementById('theory_credits').value) || 0;
            const practiceCredits = parseInt(document.getElementById('practice_credits').value) || 0;
            const errorMsg = document.getElementById('error_msg');
            if (totalCredits !== theoryCredits + practiceCredits) {
                errorMsg.style.display = 'block';
            } else {
                errorMsg.style.display = 'none';
            }
        }

        // Gán sự kiện khi thay đổi input
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', updateTotals);
            });
            // Khởi tạo tổng ban đầu
            updateTotals();
        });

        // Hàm xuất file Word (export toàn bộ nội dung trang)
        function exportToWord() {
            const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' " +
                           "xmlns:w='urn:schemas-microsoft-com:office:word' " +
                           "xmlns='http://www.w3.org/TR/REC-html40'>" +
                           "<head><meta charset='utf-8'><title>Phân Bổ Các Loại Giờ</title></head><body>";
            const footer = "</body></html>";
            const sourceHTML = header + document.body.innerHTML + footer;
            const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
            const fileDownload = document.createElement("a");
            document.body.appendChild(fileDownload);
            fileDownload.href = source;
            fileDownload.download = 'phan_bo_gio.doc';
            fileDownload.click();
            document.body.removeChild(fileDownload);
        }
    </script>
</body>
</html>